<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Orders - AgriKart</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50 text-gray-800">
  <header class="bg-green-700 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Your Orders</h1>
    <nav class="space-x-4">
      <a href="index.html" class="hover:underline">Home</a>
    </nav>
  </header>

  <main class="p-6">
    <div id="ordersContainer" class="grid gap-4"></div>
  </main>

  <script>
    const userId = localStorage.getItem("userId");
    const email = localStorage.getItem("userEmail");
    const password = localStorage.getItem("userPassword");

    if (!userId || !email || !password) {
      alert("Please log in again.");
      window.location.href = "login.html";
    }

    async function loadOrders() {
      try {
        const res = await fetch(`http://localhost:8080/api/orders/by-user?userId=${userId}`);
        const orders = await res.json();
        const container = document.getElementById("ordersContainer");
        container.innerHTML = "";

        if (!orders.length) {
          container.innerHTML = "<p class='text-center text-gray-500'>No orders found.</p>";
          return;
        }

        orders.forEach(order => {
          const orderDiv = document.createElement("div");
          orderDiv.className = "bg-white p-4 rounded shadow";

          orderDiv.innerHTML = `
            <h2 class="font-semibold text-lg mb-2">Order ID: ${order.id}</h2>
            <p><strong>Date:</strong> ${new Date(order.orderDate).toLocaleDateString()}</p>
            <p><strong>Product:</strong> ${order.productName || "N/A"}</p>
            <p><strong>Quantity:</strong> ${order.quantity || 1}</p>
            <button onclick="cancelOrder(${order.id})"
              class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
              ‚ùå Cancel Order
            </button>
          `;
          container.appendChild(orderDiv);
        });

      } catch (err) {
        alert("Failed to load orders");
        console.error(err);
      }
    }

    async function cancelOrder(orderId) {
      if (!confirm("Are you sure you want to cancel this order?")) return;

      try {
        const res = await fetch(
          `http://localhost:8080/api/orders/cancel/${orderId}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`,
          { method: 'DELETE' }
        );

        if (!res.ok) {
          const error = await res.text();
          alert("Cancel failed: " + error);
          return;
        }

        alert("Order cancelled successfully.");
        loadOrders();
      } catch (err) {
        alert("Error cancelling order.");
        console.error(err);
      }
    }

    document.addEventListener("DOMContentLoaded", loadOrders);
  </script>
</body>
</html>
