<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AgriKart Admin Dashboard</title>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      min-height: 100vh;
      background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1470&q=80');
      background-size: cover;
      background-attachment: fixed;
      color: #fff;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: rgba(0, 100, 0, 0.85);
      padding: 1rem 2rem;
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    main {
      flex: 1;
      display: flex;
      padding: 1rem 2rem;
      gap: 1rem;
      background-color: rgba(0,0,0,0.6);
    }
    nav {
      width: 220px;
      background-color: rgba(0, 70, 0, 0.8);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
    }
    nav button {
      background: none;
      border: none;
      color: #cfcfcf;
      font-size: 1.1rem;
      padding: 1rem;
      cursor: pointer;
      text-align: left;
      border-left: 5px solid transparent;
      transition: all 0.3s ease;
    }
    nav button.active,
    nav button:hover {
      background-color: #144214;
      color: #a6f4a6;
      border-left: 5px solid #7ed57e;
    }
    section {
      flex: 1;
      background-color: rgba(255,255,255,0.95);
      color: #222;
      border-radius: 8px;
      padding: 1rem 2rem;
      overflow-y: auto;
      max-height: 80vh;
    }
    h2 {
      margin-top: 0;
      color: #064006;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background-color: #a6f4a6;
    }
    tr:hover {
      background-color: #d7f7d7;
    }
    button.action-btn {
      background-color: #2e7d32;
      color: white;
      border: none;
      padding: 5px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 5px;
    }
    button.action-btn.delete {
      background-color: #c62828;
    }
    form {
      margin-bottom: 1rem;
      background-color: #f0fff0;
      padding: 1rem;
      border-radius: 8px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }
    input[readonly] {
      background-color: #ddd;
    }
    .message {
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      font-weight: 600;
    }
    .message.success {
      background-color: #b2fab4;
      color: #27632a;
    }
    .message.error {
      background-color: #f9b2b2;
      color: #7a1e1e;
    }
  </style>
</head>
<body>

	<header style="display: flex; justify-content: space-between; align-items: center;">
	  <div>AgriKart Admin Dashboard</div>
	  <button onclick="logout()" style="padding: 0.5rem 1rem; margin-right: 1rem; background-color: #c62828; color: white; border: none; border-radius: 5px; cursor: pointer;">
	    Logout
	  </button>
	</header>


<main>
  <nav>
    <button id="tab-users" class="active" onclick="showTab('users')">Users</button>
    <button id="tab-products" onclick="showTab('products')">Products</button>
    <button id="tab-orders" onclick="showTab('orders')">Orders</button>
  </nav>

  <section id="tab-content-users" style="display: none;">
    <h2>Users</h2>
    <table id="users-table">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Phone</th><th>Actions</th></tr>
      </thead>
      <tbody>
        <!-- Users will be populated here -->
      </tbody>
    </table>

    <h3>User Orders</h3>
    <table id="user-orders-table" border="1">
      <thead>
        <tr><th>Order ID</th><th>User ID</th><th>Product Name</th><th>Quantity</th><th>Date</th></tr>
      </thead>
      <tbody>
        <!-- Orders for selected user -->
      </tbody>
    </table>
  </section>

  <section id="tab-content-products" style="display:none;">
    <h2>Products</h2>

    <form id="product-form">
		<label class="block mb-2">
		  Image URL
		  <input
		    type="text"
		    id="product-imageUrl"
		    placeholder="e.g., assets/images/fertilizers/urea.jpeg"
		    class="w-full px-3 py-2 border rounded"
		    required
		  />
		</label>

      <input type="hidden" id="product-id" />
      <label for="product-code">Product Code (Unique)</label>
      <input type="text" id="product-code" placeholder="E.g., P001" required />

      <label for="product-name">Product Name</label>
      <input type="text" id="product-name" placeholder="E.g., Tractor Brand" required />

      <label for="product-category">Category</label>
      <select id="product-category" required>
        <option value="">Select Category</option>
        <option value="Pesticides">Pesticides</option>
        <option value="Tractors">Tractors</option>
        <option value="Fertilizers">Fertilizers</option>
        <option value="Seeds">Seeds</option>
        <option value="Tools">Tools</option>
      </select>

      <label for="product-use">Use</label>
      <input type="text" id="product-use" placeholder="Product use description" required />

      <label for="product-cause">Cause</label>
      <input type="text" id="product-cause" placeholder="Product cause description" required />

      <label for="product-price">Price (₹)</label>
      <input type="number" id="product-price" min="0" placeholder="E.g., 600" required />

      <label for="product-delivery">Delivery Time</label>
      <input type="text" id="product-delivery" placeholder="E.g., 4-6 days" required />

      <button type="submit" id="product-submit-btn">Add Product</button>
      <button type="button" id="product-cancel-btn" style="display:none;">Cancel Edit</button>
    </form>

    <table id="products-table">
      <thead>
        <tr>
          <th>Code</th><th>Name</th><th>Category</th><th>Price (₹)</th><th>Delivery</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Products here -->
      </tbody>
    </table>
  </section>

  <section id="tab-content-orders" style="display:none;">
    <h2>Orders</h2>
    <label for="filter-user">Filter by User:</label>
    <select id="filter-user" onchange="filterOrdersByUser()">
      <option value="">-- All Users --</option>
      <!-- Users options will be populated -->
    </select>

    <table id="orders-table">
      <thead>
        <tr><th>Order ID</th><th>User Id</th><th>Product</th><th>Quantity</th><th>Date</th></tr>
      </thead>
      <tbody>
        <!-- Orders -->
      </tbody>
    </table>
  </section>
</main>

<script>
  let users = [];
  let products = [];
  let orders = [];
  let editingProductId = null;

  function showTab(tab) {
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');

    document.querySelectorAll('main > section').forEach(sec => sec.style.display = 'none');
    document.getElementById('tab-content-' + tab).style.display = 'block';

    if (tab === 'users') loadUsers();
    if (tab === 'products') loadProducts();
    if (tab === 'orders') loadOrders();
  }

  async function loadUsers() {
    try {
      const res = await fetch('http://localhost:8080/api/users');
      users = await res.json();
      users = users.filter(u => u.role !== 'ADMIN');
      populateUsersTable();
      populateUserFilter();
    } catch (error) {
      alert('Failed to load users');
      console.error(error);
    }
  }

  function populateUsersTable() {
    const tbody = document.querySelector('#users-table tbody');
    tbody.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.fullName}</td>
        <td>${u.email}</td>
        <td>${u.phoneNumber}</td>
        <td><button class="action-btn" onclick="showUserOrders(${u.id})">View Orders</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function showUserOrders(userId) {
    fetch(`http://localhost:8080/api/orders/by-user?userId=${userId}`)
      .then(res => res.json())
      .then(userOrders => {
        if (!Array.isArray(userOrders)) {
          console.error("Response is not an array", userOrders);
          alert("Invalid response format");
          return;
        }

        const tbody = document.querySelector('#user-orders-table tbody');
        tbody.innerHTML = ''; // Clear previous orders

        userOrders.forEach(o => {
          const quantity = Array.isArray(o.orderItems)
            ? o.orderItems.reduce((sum, i) => sum + (i.quantity || 0), 0)
            : (o.quantity || 0);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${o.id}</td>
            <td>${o.userId}</td>
            <td>${o.productName || "N/A"}</td>
            <td>${quantity}</td>
            <td>${o.orderDate ? new Date(o.orderDate).toLocaleDateString() : "N/A"}</td>
          `;
          tbody.appendChild(tr);
        });
      })
      .catch(err => {
        console.error("Failed to load orders", err);
        alert("Error loading orders");
      });
  }



  function resetProductForm() {
    editingProductId = null;
    document.getElementById('product-form').reset();
    document.getElementById('product-submit-btn').textContent = 'Add Product';
    document.getElementById('product-cancel-btn').style.display = 'none';
	document.getElementById('product-imageUrl').value = '';

  }

  async function loadProducts() {
    try {
      const res = await fetch('http://localhost:8080/api/products');
      products = await res.json();
      populateProductsTable();
    } catch (error) {
      alert('Failed to load products');
      console.error(error);
    }
  }

  function populateProductsTable() {
    const tbody = document.querySelector('#products-table tbody');
    tbody.innerHTML = '';
    products.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td>${p.category}</td>
        <td>₹${p.price}</td>
        <td>${p.delivery || '-'}</td>
        <td>
          <button class="action-btn" onclick="editProduct(${p.id})">Edit</button>
          <button class="action-btn delete" onclick="deleteProduct(${p.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    editingProductId = id;
    document.getElementById('product-id').value = product.id;
    document.getElementById('product-code').value = product.code;
    document.getElementById('product-name').value = product.name;
    document.getElementById('product-category').value = product.category;
    document.getElementById('product-use').value = product.use || '';
    document.getElementById('product-cause').value = product.cause || '';
    document.getElementById('product-price').value = product.price;
    document.getElementById('product-delivery').value = product.delivery || '';
    document.getElementById('product-submit-btn').textContent = 'Update Product';
    document.getElementById('product-cancel-btn').style.display = 'inline-block';
  }

  async function deleteProduct(id) {
    const confirmed = confirm("Are you sure you want to delete this product?");
    if (!confirmed) return;

    const email = "admin@agrikart.com";
    const password = "admin123";

    try {
      const res = await fetch(`http://localhost:8080/api/products/${id}?email=${email}&password=${password}`, {
        method: "DELETE",
      });

      if (res.ok) {
        alert("Product deleted successfully");
        await loadProducts(); // re-fetch the product list
      } else {
        const error = await res.text();
        alert("Error deleting product: " + error);
      }
    } catch (err) {
      console.error("Delete failed", err);
      alert("Error deleting product.");
    }
  }


  document.getElementById('product-form').addEventListener('submit', async function (e) {
    e.preventDefault();
	const imageUrl = document.getElementById('product-imageUrl').value.trim();

    const code = document.getElementById('product-code').value.trim();
    const name = document.getElementById('product-name').value.trim();
    const category = document.getElementById('product-category').value;
    const use = document.getElementById('product-use').value.trim();
    const cause = document.getElementById('product-cause').value.trim();
    const price = parseFloat(document.getElementById('product-price').value);
    const delivery = document.getElementById('product-delivery').value.trim();

    if (!imageUrl || !code || !name || !category || !use || !cause || !delivery || isNaN(price)) {
      alert('Please fill all fields correctly.');
      return;
    }

    if (products.some(p => p.code && p.code.toLowerCase() === code.toLowerCase() && p.id !== editingProductId)) {
      alert('Product code already exists. Please use a unique code.');
      return;
    }

	const productData = {
		id: editingProductId,
	  code,
	  name,
	  category,
	  use,
	  cause,
	  price,
	  imageUrl,
	  delivery
	};



    //const adminEmail = localStorage.getItem('adminEmail');
    //const adminPassword = localStorage.getItem('adminPassword');
	const adminEmail = 'admin@agrikart.com';
	const adminPassword = 'admin123';

	
    if (!adminEmail || !adminPassword) {
      alert('Admin credentials not found. Please log in again.');
      return;
    }

    try {
      const response = await fetch(`http://localhost:8080/api/products?email=${adminEmail}&password=${adminPassword}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(productData)
      });

      if (!response.ok) {
        const errorText = await response.text();
        alert(`Failed to add product: ${errorText}`);
        return;
      }

      alert('Product added successfully!');
      resetProductForm();
      await loadProducts();
    } catch (err) {
      console.error('Error adding product:', err);
      alert('An error occurred while adding product.');
    }
  });

  
  document.getElementById('product-cancel-btn').addEventListener('click', resetProductForm);

  async function loadOrders() {
    const adminEmail = 'admin@agrikart.com';
    const adminPassword = 'admin123';

    try {
      const res = await fetch(`http://localhost:8080/api/orders/all?email=${adminEmail}&password=${adminPassword}`);
      const data = await res.json();

      if (!Array.isArray(data)) {
        console.error("Orders is not an array", data);
        return;
      }

      orders = data;
      populateOrdersTable(); // Show all orders
    } catch (error) {
      alert('Failed to load orders');
      console.error(error);
    }
  }


  function viewOrders(button) {
    const tr = button.closest("tr");
    const userId = tr.getAttribute("data-user-id");

    if (!userId) {
      alert("User ID not found for this user.");
      return;
    }

    loadOrders(userId); // Call your fetch logic with userId
  }


  function populateOrdersTable(filterUserId) {
    const tbody = document.querySelector('#orders-table tbody');
    tbody.innerHTML = '';
    if (!Array.isArray(orders)) {
      console.error("Orders is not an array", orders);
      return;
    }

    const filteredOrders = filterUserId ? orders.filter(o => o.userId == filterUserId) : orders;

    filteredOrders.forEach(o => {
      const productNames = o.productName || "N/A";
      const totalQuantity = Array.isArray(o.orderItems)
        ? o.orderItems.reduce((sum, i) => sum + (i.quantity || 0), 0)
        : (o.quantity || 0);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${o.id}</td>
       
		<td>${o.userId}</td>

        <td>${productNames}</td>
        <td>${totalQuantity}</td>
        <td>${o.orderDate ? new Date(o.orderDate).toLocaleDateString() : "N/A"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function populateUserFilter() {
    const select = document.getElementById('filter-user');
    select.innerHTML = '<option value="">-- All Users --</option>';
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = `${u.fullName} (${u.email}) ${u.id}`; // makes it unique
      select.appendChild(opt);
    });
  }


  function filterOrdersByUser() {
    const userId = document.getElementById('filter-user').value;
    populateOrdersTable(userId || null);
  }

  window.onload = () => {
    showTab('users');
  };
  
  function logout() {
    localStorage.removeItem("adminEmail");
    localStorage.removeItem("adminPassword");
    alert("Admin have been logged out.");
    window.location.href = "login.html"; // redirect to login page
  }

</script>


</body>
</html>
